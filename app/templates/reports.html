{% extends "base.html" %}

{% block title %}Reports - Customer Session Analyzer{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    .report-header h2 {
        margin: 0;
        font-weight: 600;
    }
    .table {
        border-radius: 8px;
        overflow: hidden;
    }
    .table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .table thead th {
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transition: background-color 0.2s;
    }
    
    /* Observation formatting styles */
    .observation-formatted {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    .observation-list {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }
    .observation-list li {
        position: relative;
        padding-left: 24px;
        margin-bottom: 12px;
        line-height: 1.6;
        font-size: 0.95rem;
    }
    .observation-list li:last-child {
        margin-bottom: 0;
    }
    .observation-list li::before {
        content: "‚Ä¢";
        position: absolute;
        left: 0;
        color: #667eea;
        font-size: 1.2rem;
        font-weight: bold;
        line-height: 1.4;
    }
    .observation-single {
        margin: 0;
        line-height: 1.6;
        font-size: 0.95rem;
    }
    
    /* Highlight badge styles */
    .highlight-badge {
        background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
        color: #000;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 6px;
        vertical-align: middle;
    }
    .highlight-type-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    .highlight-section-modal {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .highlight-section-modal h6 {
        color: #856404;
        margin-bottom: 10px;
        font-weight: 600;
    }
    .highlight-url {
        word-break: break-all;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-header">
    <h2>üìã Tabular Reports</h2>
    <p class="mb-0">Detailed view of all customer session records</p>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Summary Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Sessions Reviewed:</strong> {{ insights.total_sessions_reviewed }}
                    </div>
                    <div class="col-md-3">
                        <strong>Total Customers:</strong> {{ insights.total_customers }}
                    </div>
                    <div class="col-md-3">
                        <strong>Total Records:</strong> {{ insights.total_records }}
                    </div>
                    <div class="col-md-3">
                        <strong>Unique Sources:</strong> {{ insights.source_distribution|length }}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-3">
                        <strong>Unique Destinations:</strong> {{ insights.destination_distribution|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Unique Regions:</strong> {{ insights.region_distribution|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Duplicate Customers:</strong> {{ insights.duplicate_customers|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Total Time Spent:</strong> 
                        {% if insights.total_time_consumed_minutes %}
                            {{ insights.total_time_consumed_minutes }} mins ({{ insights.total_time_consumed_hours }} hrs)
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Daily Time Consumed Report -->
{% if insights.daily_time_consumed %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>üìä Daily Time Spent Watching User Sessions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Sessions Reviewed</th>
                                <th>Total Minutes</th>
                                <th>Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_data in insights.daily_time_consumed %}
                            <tr>
                                <td><strong>{{ day_data.date }}</strong></td>
                                <td>{{ day_data.session_count }} session{% if day_data.session_count != 1 %}s{% endif %}</td>
                                <td><span class="badge bg-primary">{{ day_data.total_minutes }} min{% if day_data.total_minutes != 1 %}s{% endif %}</span></td>
                                <td><span class="badge bg-success">{{ day_data.hours }} hr{% if day_data.hours != 1 %}s{% endif %}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td><strong>Total</strong></td>
                                <td><strong>{{ insights.sessions_with_time_consumed }} session{% if insights.sessions_with_time_consumed != 1 %}s{% endif %}</strong></td>
                                <td><strong><span class="badge bg-primary">{{ insights.total_time_consumed_minutes }} min{% if insights.total_time_consumed_minutes != 1 %}s{% endif %}</span></strong></td>
                                <td><strong><span class="badge bg-success">{{ insights.total_time_consumed_hours }} hr{% if insights.total_time_consumed_hours != 1 %}s{% endif %}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- All Sessions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>All Session Records</h5>
        <span class="badge bg-primary">{{ sessions|length }} records</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="sessions-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Region</th>
                        <th>Sessions</th>
                        <th>Source</th>
                        <th>Destination</th>
                        <th>Time Consumed</th>
                        <th>Highlight</th>
                        <th>Uploaded At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr>
                        <td>{{ session.id }}</td>
                        <td>{{ session.customer }}</td>
                        <td>{{ session.region }}</td>
                        <td>{{ session.sessions }}</td>
                        <td>{{ session.source }}</td>
                        <td>{{ session.destination }}</td>
                        <td>
                            {% if session.time_consumed %}
                                <span class="badge bg-info">{{ session.time_consumed }} min{% if session.time_consumed != 1 %}s{% endif %}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if session.has_highlight %}
                                <span class="badge highlight-type-badge bg-warning text-dark" title="{{ session.highlight_type }}">
                                    {% if session.highlight_type == 'error_gap' %}
                                        Error Gap
                                    {% elif session.highlight_type == 'error_wrong' %}
                                        Wrong Error
                                    {% elif session.highlight_type == 'feature_request' %}
                                        Feature Req
                                    {% elif session.highlight_type == 'wrong_behaviour' %}
                                        Wrong Behaviour
                                    {% elif session.highlight_type == 'other' %}
                                        Other
                                    {% else %}
                                        Highlight
                                    {% endif %}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ session.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') if session.uploaded_at else 'N/A' }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewDetails({{ session.id }})">
                                View
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSession({{ session.id }})">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Session Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìã Session Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="details-loading" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading details...</p>
                </div>
                <div id="details-content" style="display: none;">
                    <!-- Highlight Section (shown if has_highlight) -->
                    <div id="highlight-section" class="highlight-section-modal" style="display: none;">
                        <h6>‚≠ê Highlight</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Type:</strong> <span id="highlight-type-text"></span>
                            </div>
                            <div class="col-md-6" id="highlight-url-container" style="display: none;">
                                <strong>URL:</strong> <a href="#" id="highlight-url-link" target="_blank" class="highlight-url"></a>
                            </div>
                        </div>
                        <div id="highlight-details-container" class="mt-2" style="display: none;">
                            <strong>Details:</strong> <span id="highlight-details-text"></span>
                        </div>
                    </div>
                    
                    <!-- Observation Section -->
                    <div class="observation-formatted" id="observation-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Highlight type labels
    const highlightTypeLabels = {
        'error_gap': 'Error Message Gap',
        'error_wrong': 'Error Message Wrong',
        'feature_request': 'Feature Request',
        'wrong_behaviour': 'Not the right behaviour',
        'other': 'Other'
    };

    function formatObservation(text) {
        if (!text || !text.trim()) {
            return '<p class="text-muted">No observation provided.</p>';
        }
        
        // Split by newlines and filter empty lines
        const lines = text.split(/\n/).map(line => line.trim()).filter(line => line);
        
        if (lines.length === 0) {
            return '<p class="text-muted">No observation provided.</p>';
        }
        
        // If only one line, show as paragraph
        if (lines.length === 1) {
            return `<p class="observation-single">${escapeHtml(lines[0])}</p>`;
        }
        
        // Multiple lines - format as bullet points
        let html = '<ul class="observation-list">';
        for (const line of lines) {
            // Remove existing bullet markers (-, *, ‚Ä¢) from the start
            const cleanLine = line.replace(/^[-*‚Ä¢]\s*/, '').replace(/^\d+[.)]\s*/, '');
            if (cleanLine) {
                html += `<li>${escapeHtml(cleanLine)}</li>`;
            }
        }
        html += '</ul>';
        
        return html;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function viewDetails(sessionId) {
        // Show loading state
        document.getElementById('details-loading').style.display = 'block';
        document.getElementById('details-content').style.display = 'none';
        
        // Show modal first
        var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modal.show();
        
        // Fetch full session data from API
        fetch(`/api/sessions/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading
                document.getElementById('details-loading').style.display = 'none';
                
                // Handle highlight section
                const highlightSection = document.getElementById('highlight-section');
                if (data.has_highlight) {
                    highlightSection.style.display = 'block';
                    
                    // Set highlight type
                    const typeText = highlightTypeLabels[data.highlight_type] || data.highlight_type || 'Unknown';
                    document.getElementById('highlight-type-text').textContent = typeText;
                    
                    // Set highlight URL if present
                    const urlContainer = document.getElementById('highlight-url-container');
                    if (data.highlight_url) {
                        urlContainer.style.display = 'block';
                        const urlLink = document.getElementById('highlight-url-link');
                        urlLink.href = data.highlight_url;
                        urlLink.textContent = data.highlight_url;
                    } else {
                        urlContainer.style.display = 'none';
                    }
                    
                    // Set highlight details if present (for "other" type)
                    const detailsContainer = document.getElementById('highlight-details-container');
                    if (data.highlight_details) {
                        detailsContainer.style.display = 'block';
                        document.getElementById('highlight-details-text').textContent = data.highlight_details;
                    } else {
                        detailsContainer.style.display = 'none';
                    }
                } else {
                    highlightSection.style.display = 'none';
                }
                
                // Set observation content
                const observationContent = document.getElementById('observation-content');
                observationContent.innerHTML = formatObservation(data.observation);
                
                // Show content
                document.getElementById('details-content').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching session details:', error);
                document.getElementById('details-loading').style.display = 'none';
                document.getElementById('details-content').innerHTML = '<p class="text-danger">Error loading details. Please try again.</p>';
                document.getElementById('details-content').style.display = 'block';
            });
    }

    function deleteSession(id) {
        if (!confirm('Are you sure you want to delete this session?')) {
            return;
        }
        
        fetch(`/api/sessions/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting session: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting session: ' + error);
        });
    }
</script>
{% endblock %}


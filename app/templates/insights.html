{% extends "base.html" %}

{% block title %}Analytics & Visualizations - Customer Session Analyzer{% endblock %}

{% block extra_css %}
<style>
    .insight-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    .insight-header h2 {
        margin: 0;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="insight-header">
    <h2>üìà Analytics & Visualizations</h2>
    <p class="mb-0">Comprehensive insights from your customer session data</p>
</div>

<!-- Key Metrics - Primary Analytics -->
<div class="row mb-4">
    <div class="col-12 mb-3">
        <h3 class="mb-3">üìä Key Metrics</h3>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-left: 4px solid #28a745;">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Customers</h5>
                <h2 class="text-success mb-0">{{ insights.total_customers }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-left: 4px solid #ffc107;">
            <div class="card-body">
                <h5 class="card-title text-muted">Duplicate Customers</h5>
                <h2 class="text-warning mb-0">{{ insights.duplicate_customers_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-left: 4px solid #17a2b8;">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Time Spent</h5>
                <h2 class="text-info mb-0">
                    {% if insights.total_time_consumed_hours %}
                        {{ insights.total_time_consumed_hours }}<small style="font-size: 0.5em"> hrs</small>
                    {% else %}
                        N/A
                    {% endif %}
                </h2>
                <p class="text-muted mb-0 small">
                    {% if insights.total_time_consumed_minutes %}
                        ({{ insights.total_time_consumed_minutes }} mins)
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-left: 4px solid #007bff;">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Sessions</h5>
                <h2 class="text-primary mb-0">{{ insights.total_sessions_reviewed }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Coverage Metrics -->
<div class="row mb-4">
    <div class="col-12 mb-3">
        <h3 class="mb-3">üåç Coverage Metrics</h3>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center" style="border-left: 4px solid #6f42c1;">
            <div class="card-body">
                <h5 class="card-title text-muted">Regions Covered</h5>
                <h2 class="text-primary mb-0">{{ insights.regions_covered }}</h2>
                <p class="text-muted mb-0 small">Unique regions</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center" style="border-left: 4px solid #e83e8c;">
            <div class="card-body">
                <h5 class="card-title text-muted">Sources Covered</h5>
                <h2 class="text-primary mb-0">{{ insights.sources_covered }}</h2>
                <p class="text-muted mb-0 small">Unique sources</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center" style="border-left: 4px solid #fd7e14;">
            <div class="card-body">
                <h5 class="card-title text-muted">Destinations Covered</h5>
                <h2 class="text-primary mb-0">{{ insights.destinations_covered }}</h2>
                <p class="text-muted mb-0 small">Unique destinations</p>
            </div>
        </div>
    </div>
</div>

<!-- Region Distribution Chart -->
<div class="chart-container">
    <h4>Region Distribution (Unique Region-wise Count)</h4>
    <p class="text-muted">Breakdown of sessions by region</p>
    <div id="region-chart"></div>
    {% if insights.region_distribution %}
    <div class="mt-3">
        <table class="table table-sm table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Region</th>
                    <th class="text-end">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for region, count in insights.region_distribution.items() %}
                <tr>
                    <td><strong>{{ region }}</strong></td>
                    <td class="text-end"><span class="badge bg-primary">{{ count }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Source Distribution Chart -->
<div class="chart-container">
    <h4>Source Distribution</h4>
    <p class="text-muted">Breakdown of sessions by data source</p>
    <div id="source-chart"></div>
    {% if insights.source_distribution %}
    <div class="mt-3">
        <table class="table table-sm table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Source</th>
                    <th class="text-end">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for source, count in insights.source_distribution.items() %}
                <tr>
                    <td><strong>{{ source }}</strong></td>
                    <td class="text-end"><span class="badge bg-primary">{{ count }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Destination Distribution Chart -->
<div class="chart-container">
    <h4>Destination Distribution</h4>
    <p class="text-muted">Breakdown of sessions by destination</p>
    <div id="destination-chart"></div>
    {% if insights.destination_distribution %}
    <div class="mt-3">
        <table class="table table-sm table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Destination</th>
                    <th class="text-end">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for destination, count in insights.destination_distribution.items() %}
                <tr>
                    <td><strong>{{ destination }}</strong></td>
                    <td class="text-end"><span class="badge bg-primary">{{ count }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Uploads Over Time Chart -->
<div class="chart-container">
    <h4>Uploads Over Time</h4>
    <div id="uploads-chart"></div>
</div>

<!-- Time Consumed Chart -->
{% if insights.time_consumed_distribution %}
<div class="chart-container">
    <h4>Time Consumed Distribution</h4>
    <div id="time-consumed-chart"></div>
</div>
{% endif %}

<!-- Daily Time Consumed Chart -->
{% if insights.daily_time_consumed %}
<div class="chart-container">
    <h4>Day-wise Time Spent</h4>
    <p class="text-muted">Time spent watching sessions per day</p>
    <div id="daily-time-chart"></div>
    <div class="mt-3">
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th class="text-end">Sessions</th>
                    <th class="text-end">Total Minutes</th>
                    <th class="text-end">Total Hours</th>
                </tr>
            </thead>
            <tbody>
                {% for day_data in insights.daily_time_consumed %}
                <tr>
                    <td><strong>{{ day_data.date }}</strong></td>
                    <td class="text-end">{{ day_data.session_count }}</td>
                    <td class="text-end"><span class="badge bg-info">{{ day_data.total_minutes }} min{% if day_data.total_minutes != 1 %}s{% endif %}</span></td>
                    <td class="text-end"><span class="badge bg-success">{{ day_data.hours }} hr{% if day_data.hours != 1 %}s{% endif %}</span></td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-info">
                <tr>
                    <td><strong>Total</strong></td>
                    <td class="text-end"><strong>{{ insights.sessions_with_time_consumed }}</strong></td>
                    <td class="text-end"><strong><span class="badge bg-info">{{ insights.total_time_consumed_minutes }} min{% if insights.total_time_consumed_minutes != 1 %}s{% endif %}</span></strong></td>
                    <td class="text-end"><strong><span class="badge bg-success">{{ insights.total_time_consumed_hours }} hr{% if insights.total_time_consumed_hours != 1 %}s{% endif %}</span></strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% else %}
<div class="chart-container">
    <h4>Day-wise Time Spent</h4>
    <p class="text-muted">No time data available for daily breakdown</p>
</div>
{% endif %}

<!-- Duplicate Customers Table -->
{% if insights.duplicate_customers %}
<div class="card mt-4">
    <div class="card-header">
        <h5>üìã Duplicate Customers Details</h5>
        <p class="mb-0 small">Customers that appear in multiple session records</p>
    </div>
    <div class="card-body">
        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th>Customer</th>
                    <th class="text-end">Occurrences</th>
                </tr>
            </thead>
            <tbody>
                {% for dup in insights.duplicate_customers %}
                <tr>
                    <td><strong>{{ dup.customer }}</strong></td>
                    <td class="text-end"><span class="badge bg-warning text-dark">{{ dup.occurrences }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
    // Region Distribution Chart
    var regionData = {{ insights.region_distribution | tojson }};
    var regionTrace = {
        x: Object.keys(regionData),
        y: Object.values(regionData),
        type: 'bar',
        marker: { color: '#007bff' }
    };
    Plotly.newPlot('region-chart', [regionTrace], {
        title: 'Sessions by Region',
        xaxis: { title: 'Region' },
        yaxis: { title: 'Count' }
    });

    // Source Distribution Chart
    var sourceData = {{ insights.source_distribution | tojson }};
    var sourceTrace = {
        labels: Object.keys(sourceData),
        values: Object.values(sourceData),
        type: 'pie'
    };
    Plotly.newPlot('source-chart', [sourceTrace], {
        title: 'Sessions by Source'
    });

    // Destination Distribution Chart
    var destData = {{ insights.destination_distribution | tojson }};
    var destTrace = {
        labels: Object.keys(destData),
        values: Object.values(destData),
        type: 'pie'
    };
    Plotly.newPlot('destination-chart', [destTrace], {
        title: 'Sessions by Destination'
    });

    // Uploads Over Time Chart
    var uploadsData = {{ insights.uploads_by_date | tojson }};
    var uploadsTrace = {
        x: uploadsData.map(d => d.date),
        y: uploadsData.map(d => d.count),
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: '#28a745' }
    };
    Plotly.newPlot('uploads-chart', [uploadsTrace], {
        title: 'Uploads Over Time',
        xaxis: { title: 'Date' },
        yaxis: { title: 'Number of Uploads' }
    });

    // Time Consumed Distribution Chart
    {% if insights.time_consumed_distribution %}
    var timeData = {{ insights.time_consumed_distribution | tojson }};
    var timeTrace = {
        x: Object.keys(timeData).map(k => k + ' mins'),
        y: Object.values(timeData),
        type: 'bar',
        marker: { color: '#17a2b8' }
    };
    Plotly.newPlot('time-consumed-chart', [timeTrace], {
        title: 'Sessions by Time Consumed',
        xaxis: { title: 'Time Consumed (minutes)' },
        yaxis: { title: 'Number of Sessions' }
    });
    {% endif %}

    // Daily Time Consumed Chart
    {% if insights.daily_time_consumed %}
    var dailyTimeData = {{ insights.daily_time_consumed | tojson }};
    var dailyTimeTrace = {
        x: dailyTimeData.map(d => d.date),
        y: dailyTimeData.map(d => d.total_minutes),
        type: 'bar',
        marker: { color: '#28a745' },
        text: dailyTimeData.map(d => d.total_minutes + ' mins (' + d.session_count + ' sessions)'),
        textposition: 'outside'
    };
    Plotly.newPlot('daily-time-chart', [dailyTimeTrace], {
        title: 'Minutes Spent Watching Sessions Per Day',
        xaxis: { title: 'Date' },
        yaxis: { title: 'Total Minutes' }
    });
    {% endif %}
</script>
{% endblock %}

